
# Install Chef Server 
- name: Check the chef-server package is installed
  ignore_errors: true
  command: which chef-server-ctl
  register: check_package

- name: Check the management console installed
  ignore_errors: true
  uri:
    url: https://localhost/login
    validate_certs: false
  register: check_console

- name: Install and Configure Chef Server
  block:
    - name: install the server
      apt:
        deb: "https://packages.chef.io/files/stable/chef-server/{{ chefserver_version }}/ubuntu/18.04/chef-server-core_{{ chefserver_version }}-1_amd64.deb"
        state: present
        update_cache: yes

    - name: Configure the server
      command: chef-server-ctl reconfigure
      become: yes
  when: check_package.rc != 0

- name: Install management console
  block:
    - name: Install management component
      shell: | 
        sudo chef-server-ctl install chef-manage --accept-license
        yes
        
    - name: Reconfigure the server
      shell: sudo chef-server-ctl reconfigure --accept-license

    - name: Reconfigure the manager
      shell: sudo chef-manage-ctl reconfigure --accept-license
  when: check_console.status != 200 and (install_management_console | bool)
