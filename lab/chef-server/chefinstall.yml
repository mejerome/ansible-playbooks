
# Install Chef Server 
- name: Check the chef-server package is installed
  ignore_errors: true
  command: which chef-server-ctl
  register: check_package

- name: Check the management console installed
  ignore_errors: true
  uri:
    url: https://localhost/login
    validate_certs: false
  register: check_console

- name: Install and Configure Chef Server
  block:
    # - name: Download file with check (sha256)
    #   get_url:
    #     url: "https://packages.chef.io/files/stable/chef-server/{{ chefserver_version }}/ubuntu/18.04/chef-server-core_{{ chefserver_version }}-1_amd64.deb"
    #     dest: "/tmp/chef-server-core_{{ chefserver_version }}-1_amd64.deb"
        # checksum: "sha256: {{ chefserver_checksum }}"

    - name: Install the server
      apt:
        deb: "/srv/website/chef-server-core_13.2.0-1_amd64.deb"
        state: present
  when: check_package.rc != 0

- name: Install management console
  block:
    - name: Configure the server
      shell: |
        chef-server-ctl reconfigure
        yes
      become: yes
      
    - name: Install management component
      command: chef-server-ctl install chef-manage --accept-license
      become: yes
        
    - name: Reconfigure the server
      shell: sudo chef-server-ctl reconfigure --accept-license

    - name: Reconfigure the manager
      shell: sudo chef-manage-ctl reconfigure --accept-license
  when: check_console.status != 200 and (install_management_console | bool)
